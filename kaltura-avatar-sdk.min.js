/*!
 * Kaltura Avatar SDK v1.0.0
 * https://github.com/anthropics/claude-code
 *
 * Embed Kaltura AI Avatar conversations in any website.
 * Zero dependencies. Works with any framework.
 *
 * MIT License
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).KalturaAvatarSDK=e()}(this,function(){"use strict";const t=Object.freeze({SHOWING_JOIN_MEETING:"showing-join-meeting",JOIN_MEETING_CLICKED:"join-meeting-clicked",SHOWING_AGENT:"showing-agent",AGENT_TALKED:"agent-talked",USER_TRANSCRIPTION:"user-transcription",PRONUNCIATION_SCORE:"pronunciation-score",PERMISSIONS_DENIED:"permissions-denied",CONVERSATION_ENDED:"conversation-ended",LOAD_AGENT_ERROR:"load-agent-error"}),e=Object.freeze({UNINITIALIZED:"uninitialized",INITIALIZING:"initializing",READY:"ready",IN_CONVERSATION:"in-conversation",ENDED:"ended",ERROR:"error"}),s={apiBaseUrl:"https://api.avatar.us.kaltura.ai",meetBaseUrl:"https://meet.avatar.us.kaltura.ai",debug:!1,iframeClass:"kaltura-avatar-iframe",iframeStyles:{width:"100%",height:"100%",border:"none",borderRadius:"12px"}};class i{constructor(t={}){if(!t.clientId)throw new Error("clientId is required");if(!t.flowId)throw new Error("flowId is required");this._clientId=t.clientId,this._flowId=t.flowId,this._config={...s,...t.config},this._container=null,this._iframe=null,this._state=e.UNINITIALIZED,this._assets=null,this._listeners=new Map,this._onMessage=this._handleMessage.bind(this),this._transcript=[],this._transcriptEnabled=!0,t.container&&this.setContainer(t.container)}setContainer(t){if("string"==typeof t){if(this._container=document.querySelector(t),!this._container)throw new Error(`Container not found: ${t}`)}else{if(!(t instanceof HTMLElement))throw new Error("Container must be HTMLElement or selector string");this._container=t}return this}async init(){if(this._state!==e.UNINITIALIZED)return this._assets;this._setState(e.INITIALIZING);try{const t=`${this._config.apiBaseUrl}/clients/${this._clientId}/flow/${this._flowId}/sdk-assets`,s=await fetch(t);if(!s.ok)throw new Error(`HTTP ${s.status}`);return this._assets=await s.json(),window.addEventListener("message",this._onMessage),this._setState(e.READY),this._emit("ready",{assets:this._assets}),this._assets}catch(t){throw this._setState(e.ERROR),this._emit("error",{message:t.message}),t}}async start(t={}){if(!this._container)throw new Error("Container not set. Call setContainer() first.");return this._state===e.UNINITIALIZED&&await this.init(),this._state!==e.READY&&this._state!==e.ENDED||(this._transcript=[],this._iframe=this._createIframe(t.styles),this._container.innerHTML="",this._container.appendChild(this._iframe),this._setState(e.IN_CONVERSATION),this._emit("started",{iframe:this._iframe})),this._iframe}end(){this._iframe&&(this._iframe.src="about:blank",this._iframe.remove(),this._iframe=null),this._setState(e.ENDED),this._emit("ended",{})}destroy(){this.end(),window.removeEventListener("message",this._onMessage),this._listeners.clear(),this._assets=null,this._setState(e.UNINITIALIZED)}injectPrompt(t){return!(!t||"string"!=typeof t)&&this._postToIframe({type:"eself-dynamic-prompt-message",content:t})}sendMessage(t){return this._postToIframe(t)}on(t,e){return this._listeners.has(t)||this._listeners.set(t,new Set),this._listeners.get(t).add(e),()=>this.off(t,e)}off(t,e){const s=this._listeners.get(t);s&&s.delete(e)}once(t,e){const s=i=>{this.off(t,s),e(i)};return this.on(t,s)}getState(){return this._state}getAssets(){return this._assets}getAvatarInfo(){return this._assets?.avatar||null}getIframe(){return this._iframe}getTalkUrl(){return this._assets?.talk_url||null}getClientId(){return this._clientId}getFlowId(){return this._flowId}setTranscriptEnabled(t){this._transcriptEnabled=!!t}getTranscript(){return[...this._transcript]}clearTranscript(){this._transcript=[]}getTranscriptText(t={}){const{includeTimestamps:e=!0,format:s="text"}=t;if("json"===s)return JSON.stringify(this._transcript,null,2);return this._transcript.map(t=>{const i=e?`[${t.timestamp.toLocaleTimeString()}] `:"",n="markdown"===s?`**${t.role}**`:t.role;return`${i}${n}: ${t.text}`}).join("markdown"===s?"\n\n":"\n")}downloadTranscript(t={}){const{filename:e,format:s="text",includeTimestamps:i=!0}=t,n=this.getTranscriptText({format:s,includeTimestamps:i}),a="json"===s?"json":"markdown"===s?"md":"txt",r="json"===s?"application/json":"text/plain",o=e||`transcript-${new Date().toISOString().slice(0,10)}.${a}`,c=new Blob([n],{type:r}),l=URL.createObjectURL(c),d=document.createElement("a");d.href=l,d.download=o,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(l)}_createIframe(t={}){const e=document.createElement("iframe");return e.id="kaltura-avatar-iframe",e.className=this._config.iframeClass,e.src=this._assets.talk_url,e.frameBorder="0",e.sandbox="allow-same-origin allow-scripts allow-forms",e.allow=[`camera ${this._config.meetBaseUrl}`,`microphone ${this._config.meetBaseUrl}`,`display-capture ${this._config.meetBaseUrl}`].join("; "),Object.assign(e.style,this._config.iframeStyles,t),e}_postToIframe(t){return!!this._iframe?.contentWindow&&(this._iframe.contentWindow.postMessage(t,"*"),!0)}_handleMessage(s){const{data:i}=s;if(!i||"eself-conversation-events"!==i.issuer)return;i.event&&this._emit(i.event,i.data||{});if(this._transcriptEnabled){if(i.event===t.AGENT_TALKED){const t=i.data?.agentContent||i.data;t&&"string"==typeof t&&this._transcript.push({role:"Avatar",text:t,timestamp:new Date})}else if(i.event===t.USER_TRANSCRIPTION){const t=i.data?.userTranscription||i.data;t&&"string"==typeof t&&this._transcript.push({role:"User",text:t,timestamp:new Date})}}i.event===t.CONVERSATION_ENDED?this._setState(e.ENDED):i.event===t.LOAD_AGENT_ERROR&&this._setState(e.ERROR)}_setState(t){const e=this._state;this._state=t,e!==t&&this._emit("stateChange",{from:e,to:t})}_emit(t,e){const s=this._listeners.get(t);s&&s.forEach(t=>{try{t(e)}catch(t){console.error(t)}});const i=this._listeners.get("*");i&&i.forEach(s=>{try{s({event:t,data:e})}catch(t){console.error(t)}})}}return i.Events=t,i.State=e,i.VERSION="1.0.0",i});
